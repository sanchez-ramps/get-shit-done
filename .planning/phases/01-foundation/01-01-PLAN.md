---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/jira-init.md
autonomous: false

must_haves:
  truths:
    - "User can run gsd:jira-init and configure Jira connection"
    - "acli installation is verified before any prompts"
    - "acli authentication is verified before any prompts"
    - "User can select Jira project from list or enter key directly"
    - "User can select board when multiple exist"
    - "Config files are created in .planning/jira/"
  artifacts:
    - path: "commands/gsd/jira-init.md"
      provides: "GSD command for Jira initialization"
      min_lines: 200
      contains: "name: gsd:jira-init"
  key_links:
    - from: "commands/gsd/jira-init.md"
      to: "acli commands"
      via: "Bash tool execution"
      pattern: "acli jira"
    - from: "commands/gsd/jira-init.md"
      to: ".planning/jira/config.yaml"
      via: "Write tool"
      pattern: "config\\.yaml"
    - from: "commands/gsd/jira-init.md"
      to: ".planning/jira/mapping.yaml"
      via: "Write tool"
      pattern: "mapping\\.yaml"
---

<objective>
Create the `gsd:jira-init` command that configures Jira connection for GSD integration.

Purpose: Establish the foundation for GSD-Jira sync by creating a command that verifies acli setup, guides project/board selection, and creates configuration files.

Output: Working `commands/gsd/jira-init.md` command file that creates `.planning/jira/config.yaml` and `.planning/jira/mapping.yaml` when run.
</objective>

<execution_context>
@/home/vedmahadeo/projects/get-shit-done/get-shit-done/workflows/execute-plan.md
@/home/vedmahadeo/projects/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Reference existing GSD commands for patterns
@commands/gsd/settings.md
@commands/gsd/new-project.md
</context>

<config_schemas>
## config.yaml Structure

```yaml
# GSD-Jira Configuration
# Created by gsd:jira-init

jira:
  site: "https://your-domain.atlassian.net"
  project:
    key: "PROJ"
    name: "Project Name"
    id: "10001"
  board:
    id: "1"
    name: "PROJ board"
    type: "scrum"

sync:
  mode: "push"  # push = GSD → Jira (default for Phase 1-2)
  
# Status mapping deferred to Phase 2 (auto-detected from workflow)
```

## mapping.yaml Structure

```yaml
# GSD-Jira Entity Mapping
# Fixed mapping - do not edit unless you understand the implications

# GSD Entity → Jira Issue Type
# Falls back to alternative if primary not available

entities:
  milestone:
    primary: "Initiative"      # Requires Advanced Roadmaps
    fallback: "Epic"           # Standard Jira
  phase:
    primary: "Epic"
    fallback: "Story"          # If Epic used for Milestone
  plan:
    primary: "Story"
    fallback: "Task"           # If Story used for Phase
  task:
    primary: "Sub-task"
    fallback: "Task"           # If Sub-task not available

# Detected issue types (populated during init)
available_types: []

# Active mapping (resolved during init based on available types)
active:
  milestone: null
  phase: null
  plan: null
  task: null
```
</config_schemas>

<acli_commands>
## acli Commands Reference

| Operation | Command | Output |
|-----------|---------|--------|
| Check installation | `acli --version` | Version string or ENOENT |
| Check auth | `acli jira auth status` | Account info or error |
| List projects | `acli jira project list --json` | JSON array of projects |
| View project | `acli jira project view --key PROJ --json` | Project details with issue types |
| Search boards | `acli jira board search --project PROJ --type scrum --json` | JSON array of boards |

## Error Translation

| acli Error | User-Friendly Message |
|------------|----------------------|
| ENOENT (command not found) | "acli is not installed. Install from: https://developer.atlassian.com/cloud/acli/guides/install-acli/" |
| "not authenticated" in stderr | "acli is not authenticated. Run: acli jira auth login --web" |
| Non-zero exit + network error | "Network error connecting to Jira. Check your internet connection and try again." |
| "project not found" | "Project 'KEY' not found. Check the project key and your permissions." |
</acli_commands>

<tasks>

<task type="auto">
  <name>Task 1: Create jira-init.md command with verification flow</name>
  <files>commands/gsd/jira-init.md</files>
  <action>
Create `commands/gsd/jira-init.md` following the GSD command pattern from settings.md and new-project.md.

**Command structure:**
```markdown
---
name: gsd:jira-init
description: Configure Jira connection for GSD integration
allowed-tools:
  - Read
  - Write
  - Bash
  - AskUserQuestion
---

<objective>
Configure Jira connection by verifying acli authentication and creating configuration files.
Creates: .planning/jira/config.yaml, .planning/jira/mapping.yaml
</objective>

<process>
## 1. Verify acli Installation
## 2. Verify Authentication  
## 3. Select Project
## 4. Select Board
## 5. Detect Issue Types
## 6. Create Configuration Files
## 7. Show Summary
</process>

<success_criteria>
- [ ] acli installed and authenticated
- [ ] .planning/jira/config.yaml created
- [ ] .planning/jira/mapping.yaml created
</success_criteria>
```

**Process section implementation:**

**Step 1: Verify acli Installation**
- Run `acli --version` via Bash
- On ENOENT: Show installation URL and exit
- On success: Continue

**Step 2: Verify Authentication**
- Run `acli jira auth status` via Bash
- On failure: Show "Run: acli jira auth login --web" and exit
- On success: Extract site URL from output for later use

**Step 3: Select Project**
- Run `acli jira project list --json` 
- Parse JSON to get project list
- Use AskUserQuestion with header "Project", showing projects as options
- Include "Enter key directly" option for speed (per CONTEXT.md)
- Store selected project key, name, id

**Step 4: Select Board**
- Run `acli jira board search --project {KEY} --type scrum --json`
- If exactly 1 board: Auto-select with confirmation
- If multiple boards: Use AskUserQuestion to select
- If no scrum boards: Check for kanban boards, or error
- Store board id, name, type

**Step 5: Detect Issue Types**
- Run `acli jira project view --key {KEY} --json`
- Parse issueTypes from response
- Check for: Initiative, Epic, Story, Sub-task, Task
- Resolve active mapping based on available types:
  - If Initiative available: milestone=Initiative, phase=Epic, plan=Story, task=Sub-task
  - If no Initiative: milestone=Epic, phase=Story, plan=Task, task=Sub-task
  - If no Sub-task: task=Task

**Step 6: Create Configuration Files**
- Create `.planning/jira/` directory
- Write config.yaml with site, project, board info
- Write mapping.yaml with available types and active mapping
- Include helpful comments in YAML files

**Step 7: Show Summary**
- Display success banner
- Show what was configured (project, board, mapping)
- Show Jira project URL
- Show next steps: `/gsd:jira-sync` (Phase 2)

**Error handling throughout:**
- Catch acli errors and translate to friendly messages
- On network errors: Explain what failed, suggest retry
- If project doesn't exist: Guide user to create in Jira UI first
  </action>
  <verify>
File exists: `ls commands/gsd/jira-init.md`
File has correct frontmatter: `head -10 commands/gsd/jira-init.md | grep "name: gsd:jira-init"`
File has process steps 1-7: `grep -c "## [0-9]" commands/gsd/jira-init.md` shows 7
  </verify>
  <done>
jira-init.md exists with:
- YAML frontmatter (name, description, allowed-tools)
- objective section
- process section with 7 steps
- success_criteria section
- All verification and selection logic documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Add re-init and edge case handling</name>
  <files>commands/gsd/jira-init.md</files>
  <action>
Enhance the jira-init.md command to handle re-initialization and edge cases.

**Re-init behavior (per CONTEXT.md: "additive — only update what's specified"):**

Add check at start of process:
```markdown
## 0. Check Existing Configuration

Check if .planning/jira/config.yaml exists:
- If exists: Read current config, show "Re-initializing. Current: {project} / {board}"
- Use AskUserQuestion: "Update configuration?"
  - "Update project and board" - Full re-init
  - "Update board only" - Keep project, re-select board
  - "Cancel" - Exit without changes

On re-init:
- Preserve any custom settings not being updated
- Show diff of what changed
```

**Edge cases to handle:**

1. **No projects accessible:**
   - Show: "No Jira projects found. Check your permissions or create a project at {site}/secure/BrowseProjects.jspa"
   
2. **Project key entered doesn't exist:**
   - Run `acli jira project view --key {KEY} --json`
   - On failure: "Project '{KEY}' not found. Available projects: {list first 5}"
   - Offer to retry or exit

3. **No boards for project:**
   - Show: "No Scrum boards found for {KEY}. Create a board in Jira: {site}/secure/RapidBoard.jspa"
   - Note: Kanban boards work too, just show warning about sprint features

4. **Issue type detection fails:**
   - If can't determine available types, use safe defaults:
   - milestone=Epic, phase=Story, plan=Task, task=Sub-task
   - Show warning that Advanced Roadmaps features won't work

5. **Partial config exists:**
   - If config.yaml exists but mapping.yaml doesn't (or vice versa)
   - Recreate both files for consistency

**Add helpful comments to YAML output:**

config.yaml header:
```yaml
# GSD-Jira Configuration
# Generated by gsd:jira-init on {date}
# 
# To reconfigure: /gsd:jira-init
# To sync: /gsd:jira-sync (after Phase 2)
```

mapping.yaml header:
```yaml
# GSD-Jira Entity Mapping
# Generated by gsd:jira-init on {date}
#
# This file maps GSD entities to Jira issue types.
# The 'active' section shows what's actually being used based on
# available issue types in your Jira project.
#
# DO NOT edit 'active' manually - run gsd:jira-init to reconfigure
```
  </action>
  <verify>
Re-init check exists: `grep -c "Check Existing Configuration\|Re-initializing" commands/gsd/jira-init.md` >= 1
Edge cases documented: `grep -c "No projects\|not found\|No Scrum boards\|Issue type detection" commands/gsd/jira-init.md` >= 3
YAML comments documented: `grep -c "Generated by gsd:jira-init" commands/gsd/jira-init.md` >= 1
  </verify>
  <done>
jira-init.md enhanced with:
- Re-init detection and additive update flow
- Edge case handling for empty/missing data
- Helpful YAML comments in generated files
- User guidance for Jira project/board creation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete gsd:jira-init command that:
1. Verifies acli installation and authentication
2. Lists and selects Jira project
3. Detects and selects Scrum board
4. Detects available issue types and resolves mapping
5. Creates .planning/jira/config.yaml and mapping.yaml
6. Handles re-init and edge cases
  </what-built>
  <how-to-verify>
1. Review command file: `cat commands/gsd/jira-init.md`
2. Verify structure matches GSD command pattern (compare to settings.md)
3. Check all 7+ process steps are documented
4. Verify error messages are user-friendly

**Optional live test (if acli is configured):**
5. Run `/gsd:jira-init` in a fresh context
6. Verify it prompts for project selection
7. Check `.planning/jira/config.yaml` is created correctly
8. Check `.planning/jira/mapping.yaml` has resolved active mapping
  </how-to-verify>
  <resume-signal>Type "approved" if command looks correct, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
## Phase 1 Verification Checks

After plan completion, verify:

1. **Command exists and follows pattern:**
   ```bash
   ls commands/gsd/jira-init.md
   head -20 commands/gsd/jira-init.md
   ```

2. **All required sections present:**
   - [ ] YAML frontmatter with name, description, allowed-tools
   - [ ] objective section
   - [ ] process section with numbered steps
   - [ ] success_criteria section

3. **Key functionality documented:**
   - [ ] acli --version check
   - [ ] acli jira auth status check
   - [ ] acli jira project list --json
   - [ ] acli jira board search --project PROJ --json
   - [ ] acli jira project view --key PROJ --json
   - [ ] Write to .planning/jira/config.yaml
   - [ ] Write to .planning/jira/mapping.yaml

4. **Error handling documented:**
   - [ ] acli not installed message
   - [ ] acli not authenticated message
   - [ ] No projects accessible message
   - [ ] No boards found message
</verification>

<success_criteria>
1. `commands/gsd/jira-init.md` exists with valid GSD command structure
2. Command documents full init flow (verify → select → configure)
3. Config and mapping YAML schemas defined in process steps
4. Error handling covers common pitfalls from research
5. Re-init behavior handles additive updates
6. Human verification confirms command is ready for use
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`

The SUMMARY should capture:
- What was built (jira-init.md command)
- Config file schemas (config.yaml, mapping.yaml)
- Key implementation decisions
- Next steps (Phase 2: Push Sync)
</output>
