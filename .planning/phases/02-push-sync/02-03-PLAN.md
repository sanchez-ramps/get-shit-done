---
phase: 02-push-sync
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - commands/gsd/new-milestone.md
  - commands/gsd/add-phase.md
autonomous: true

must_haves:
  truths:
    - "New milestones automatically trigger Jira Initiative creation"
    - "New phases automatically trigger Jira Epic creation"
    - "Auto-sync can be toggled via config setting"
    - "Sync failures queued as pending, command still succeeds"
    - "Success feedback shown inline after command output"
  artifacts:
    - path: "commands/gsd/new-milestone.md"
      provides: "Milestone command with Jira auto-sync hook"
      contains: "jira.*sync"
    - path: "commands/gsd/add-phase.md"
      provides: "Add phase command with Jira auto-sync hook"
      contains: "jira.*sync"
  key_links:
    - from: "commands/gsd/new-milestone.md"
      to: "jira-sync patterns"
      via: "auto-sync hook section"
      pattern: "auto.*sync|jira.*hook"
    - from: "commands/gsd/add-phase.md"
      to: "jira-sync patterns"
      via: "auto-sync hook section"
      pattern: "auto.*sync|jira.*hook"
---

<objective>
Add Jira auto-sync hooks to GSD commands so new milestones and phases automatically sync to Jira.

Purpose: Per CONTEXT.md decisions, hooks fire "immediately after GSD command completes" with inline feedback.

Output: Modified new-milestone.md and add-phase.md (or plan-phase.md) with auto-sync sections.
</objective>

<execution_context>
@/home/vedmahadeo/projects/get-shit-done/get-shit-done/workflows/execute-plan.md
@/home/vedmahadeo/projects/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-push-sync/02-CONTEXT.md
@.planning/phases/02-push-sync/02-RESEARCH.md
@commands/gsd/new-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-sync hook to new-milestone command</name>
  <files>commands/gsd/new-milestone.md</files>
  <action>
Read and modify commands/gsd/new-milestone.md to add Jira auto-sync:

1. **Add Jira integration section** (new section after main milestone creation):

```markdown
<jira_auto_sync>

## Jira Auto-Sync (if configured)

After milestone creation completes, check for Jira integration:

### Step 1: Check if Jira configured
- Look for `.planning/jira/config.yaml`
- If not exists: skip Jira sync silently

### Step 2: Check if auto-sync enabled
- Read `sync.enabled` from config.yaml
- If false or missing: skip silently

### Step 3: Attempt sync
- Load sync-state.yaml (create empty if missing)
- Read mapping.yaml for milestone → Jira type
- Create Jira issue:

```bash
acli jira workitem create \
  --project "{project.key}" \
  --type "{mapping.milestone.jiraType}" \
  --summary "Milestone: {milestone-name}" \
  --description "{milestone goal}" \
  --json
```

### Step 4: Handle result
**On success:**
- Update sync-state.yaml with jiraKey
- Print inline: `→ Synced to Jira: PROJ-45`

**On failure:**
- Add to pending queue in sync-state.yaml
- Print warning: `⚠ Jira sync failed: {reason}. Run /gsd:jira-sync to retry.`
- Command continues (does NOT fail)

### Step 5: First sync prompt
If this is first sync after jira-init (sync-state.yaml empty or missing):
- Count existing GSD artifacts
- If > 0: "Found {N} unsynced items. Run /gsd:jira-sync to sync all?"
- If 0: proceed normally

</jira_auto_sync>
```

2. **Integration point**: Add reference to this section at the END of the command's execution flow, after all GSD artifacts are created.

3. **Offline handling** (per CONTEXT.md):
- Network error → queue silently, no prompt
- Auth error → warn with "Run `acli jira login`"
  </action>
  <verify>
commands/gsd/new-milestone.md contains:
- `<jira_auto_sync>` section
- Check for config.yaml
- Check for sync.enabled setting
- acli workitem create command
- Success inline feedback: "→ Synced to Jira:"
- Failure queuing with warning
  </verify>
  <done>
new-milestone.md has Jira auto-sync hook that creates Initiative on milestone creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auto-sync hook to add-phase command</name>
  <files>commands/gsd/add-phase.md</files>
  <action>
Read and modify commands/gsd/add-phase.md (or plan-phase.md if that's where phases are created) to add Jira auto-sync:

1. **First: Identify correct command**
- Check if add-phase.md exists
- If not, check plan-phase.md
- Phases are added via one of these commands

2. **Add Jira integration section** (similar pattern to new-milestone):

```markdown
<jira_auto_sync>

## Jira Auto-Sync (if configured)

After phase addition completes, check for Jira integration:

### Step 1: Check if Jira configured
- Look for `.planning/jira/config.yaml`
- If not exists: skip silently

### Step 2: Check if auto-sync enabled
- Read `sync.enabled` from config.yaml
- If false: skip silently

### Step 3: Ensure parent synced
- Read sync-state.yaml
- Check if milestone has jiraKey
- If not: sync milestone first (creates Initiative)

### Step 4: Create Epic for phase
```bash
acli jira workitem create \
  --project "{project.key}" \
  --type "Epic" \
  --summary "Phase {N}: {phase-name}" \
  --description "{phase goal from ROADMAP}" \
  --parent "{milestone-jira-key}" \
  --json
```

### Step 5: Handle result
**On success:**
- Update sync-state.yaml with jiraKey, parentKey
- Print: `→ Synced to Jira: PROJ-46 (Epic)`

**On failure:**
- Add to pending queue
- Print: `⚠ Jira sync failed: {reason}. Queued for retry.`

### Step 6: Multi-item sync
If phase creation also creates plans (e.g., from plan-phase):
- After Epic created, create Story for each plan
- Use Epic's jiraKey as parent
- Report all created issues in summary

</jira_auto_sync>
```

3. **Hierarchy enforcement**:
- Always ensure parent exists before creating child
- Sync order: Milestone → Phase → Plans

4. **Multi-item commands** (per CONTEXT.md):
- If command creates multiple items (Epic + Stories), sync all
- Report table at end showing all created issues
  </action>
  <verify>
Phase creation command (add-phase.md or plan-phase.md) contains:
- `<jira_auto_sync>` section
- Parent sync check (milestone must have jiraKey)
- Epic creation with --parent flag
- Story creation for plans if applicable
- Success/failure handling with inline feedback
  </verify>
  <done>
Phase creation command has Jira auto-sync hook that creates Epic and links to parent Initiative.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. new-milestone.md has `<jira_auto_sync>` section
2. add-phase.md (or plan-phase.md) has `<jira_auto_sync>` section
3. Both check for config.yaml and sync.enabled
4. Both use acli workitem create with --json
5. Phase sync ensures parent milestone is synced first
6. Success shows inline "→ Synced to Jira: KEY"
7. Failure queues to pending and warns
</verification>

<success_criteria>
- [ ] new-milestone.md modified with auto-sync hook
- [ ] Phase command modified with auto-sync hook
- [ ] Config check for sync.enabled
- [ ] Parent hierarchy enforced (milestone before phase)
- [ ] Inline success feedback
- [ ] Failure queuing without blocking command
- [ ] First sync prompt for existing items
</success_criteria>

<output>
After completion, create `.planning/phases/02-push-sync/02-03-SUMMARY.md`
</output>
