---
phase: 02-push-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/jira-sync.md
autonomous: true

must_haves:
  truths:
    - "gsd:jira-sync command exists and can be invoked"
    - "Sync state tracked in .planning/jira/sync-state.yaml"
    - "Milestones create Initiatives (or Epic fallback) in Jira"
    - "Phases create Epics linked to parent Initiative"
    - "Plans create Stories linked to parent Epic"
    - "Hierarchy preserved: Initiative → Epic → Story"
  artifacts:
    - path: "commands/gsd/jira-sync.md"
      provides: "Main sync command with full push logic"
      min_lines: 400
  key_links:
    - from: "commands/gsd/jira-sync.md"
      to: "acli jira workitem create"
      via: "shell command execution"
      pattern: "acli.*workitem.*create.*--parent"
    - from: "commands/gsd/jira-sync.md"
      to: ".planning/jira/sync-state.yaml"
      via: "YAML read/write"
      pattern: "sync-state\\.yaml"
    - from: "commands/gsd/jira-sync.md"
      to: ".planning/"
      via: "artifact discovery"
      pattern: "\\.planning/(ROADMAP|phases)"
---

<objective>
Create the core gsd:jira-sync command that pushes GSD artifacts (milestones, phases, plans) to Jira with proper hierarchy linking.

Purpose: This is the foundation for all push sync functionality. It establishes the sync-state tracking pattern, artifact parsing, and acli issue creation with hierarchy.

Output: A complete `commands/gsd/jira-sync.md` command that can sync GSD artifacts to Jira.
</objective>

<execution_context>
@/home/vedmahadeo/projects/get-shit-done/get-shit-done/workflows/execute-plan.md
@/home/vedmahadeo/projects/get-shit-done/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-push-sync/02-CONTEXT.md
@.planning/phases/02-push-sync/02-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@commands/gsd/jira-init.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create jira-sync.md with sync-state management</name>
  <files>commands/gsd/jira-sync.md</files>
  <action>
Create the gsd:jira-sync command file with the following structure:

1. **Frontmatter**: name, description, tools (Read, Write, Bash, Glob)

2. **Role section**: Explain this syncs GSD artifacts to Jira

3. **Sync State Schema** (define in command):
```yaml
# .planning/jira/sync-state.yaml
version: 1
lastFullSync: ISO-timestamp

entities:
  milestones:
    "milestone-id":
      jiraKey: PROJ-XX
      jiraUrl: https://site.atlassian.net/browse/PROJ-XX
      parentKey: null
      lastSynced: ISO-timestamp
      localHash: content-hash
  phases:
    "01-foundation":
      jiraKey: PROJ-XX
      parentKey: PROJ-XX  # milestone's key
      ...
  plans:
    "01-01":
      jiraKey: PROJ-XX
      parentKey: PROJ-XX  # phase's key
      ...

pending:
  - type: phase
    id: "02-push-sync"
    action: create
    reason: "error message"
    timestamp: ISO-timestamp
```

4. **Sync state operations**:
- `loadSyncState()`: Read YAML, return empty state if not exists
- `saveSyncState(state)`: Write YAML with AUTO-GENERATED header
- `isEntitySynced(type, id)`: Check if entity has jiraKey
- `updateEntitySync(type, id, jiraKey, parentKey)`: Record successful sync
- `addToPending(type, id, action, reason)`: Queue failed sync

5. **Execution flow** (define steps):
- Step 1: Load config.yaml and mapping.yaml (from Phase 1)
- Step 2: Verify acli auth status
- Step 3: Load sync-state.yaml (create if missing)
- Step 4: Discover GSD artifacts to sync
- Step 5: Check for --dry-run flag
- Step 6: Sync entities (milestones → phases → plans)
- Step 7: Report results in table format
- Step 8: Save updated sync-state.yaml

Use YAML library pattern from Phase 1 (yaml package with Document for comments).
  </action>
  <verify>
File exists at commands/gsd/jira-sync.md with:
- Frontmatter with name, description, tools
- Sync state YAML schema documented
- Load/save sync state operations defined
- Execution flow with 8 steps outlined
  </verify>
  <done>
jira-sync.md exists with sync-state schema and management patterns defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GSD artifact discovery and parsing</name>
  <files>commands/gsd/jira-sync.md</files>
  <action>
Add artifact discovery section to jira-sync.md:

1. **Milestone detection**:
- Read `.planning/ROADMAP.md`
- Parse frontmatter for milestone metadata (if exists)
- Extract milestone name from `## Milestone:` or project name
- For v1, treat the entire project as one milestone (from PROJECT.md)
- Hash: combine project name + goal for change detection

2. **Phase detection**:
- List `.planning/phases/*/` directories
- For each phase directory:
  - Read `*-CONTEXT.md` or `*-RESEARCH.md` for description
  - Extract phase name from directory (e.g., "01-foundation" → "Foundation")
  - Get goal from ROADMAP.md phase entry
- Hash: combine phase name + goal + status

3. **Plan detection**:
- For each phase, list `*-PLAN.md` files
- Extract plan objective from `<objective>` section
- Get status from corresponding SUMMARY.md if exists
- Hash: combine plan number + objective

4. **Sync queue building**:
- Compare discovered artifacts against sync-state
- Queue items where:
  - No jiraKey exists (new)
  - localHash differs (updated, but check conflict first)
- Respect hierarchy order: milestones first, then phases, then plans

5. **Conflict detection** (per CONTEXT.md decisions):
- For updates: check if Jira issue modified since lastSynced
- Use acli: `acli jira workitem view KEY --fields updated --json`
- If Jira modified more recently: skip by default, warn user
- Support `--overwrite` flag to force push

Add clear examples of artifact discovery output.
  </action>
  <verify>
jira-sync.md contains:
- Milestone detection from PROJECT.md/ROADMAP.md
- Phase detection from .planning/phases/*
- Plan detection from *-PLAN.md files
- Hash computation for change detection
- Conflict detection with Jira updated check
  </verify>
  <done>
Artifact discovery and parsing fully documented with hierarchy order and conflict detection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Jira issue creation with hierarchy linking</name>
  <files>commands/gsd/jira-sync.md</files>
  <action>
Complete the jira-sync.md with issue creation logic:

1. **Issue type mapping** (read from mapping.yaml):
```yaml
# Default mapping (from Phase 1)
milestone:
  jiraType: Initiative  # Falls back to Epic if not available
phase:
  jiraType: Epic
plan:
  jiraType: Story
```

2. **Create milestone issue**:
```bash
acli jira workitem create \
  --project "PROJ" \
  --type "Initiative" \  # or Epic fallback
  --summary "Milestone: {name}" \
  --description "{goal from PROJECT.md}" \
  --json
```
- Handle Initiative not available error → retry with Epic
- Parse response: extract key, self URL
- Store in sync-state under milestones

3. **Create phase issue** (with parent):
```bash
acli jira workitem create \
  --project "PROJ" \
  --type "Epic" \
  --summary "Phase {N}: {name}" \
  --description "{goal from ROADMAP.md}" \
  --parent "{milestone-jira-key}" \
  --json
```
- Ensure parent milestone synced first
- Link to parent using --parent flag

4. **Create plan issue** (with parent):
```bash
acli jira workitem create \
  --project "PROJ" \
  --type "Story" \
  --summary "Plan {phase}-{plan}: {brief objective}" \
  --description "{objective from PLAN.md}" \
  --parent "{phase-jira-key}" \
  --json
```

5. **Update existing issues** (when localHash changed):
```bash
acli jira workitem edit \
  --key "PROJ-XX" \
  --summary "{updated summary}" \
  --description "{updated description}" \
  --json
```

6. **Progress output** (per CONTEXT.md decisions):
- Default verbosity: progress
- Show: "Creating Epic: Phase 2... ✓"
- On completion: table with Item | Action | Jira Key | Link

7. **Error handling**:
- Network error → add to pending, warn, continue
- Auth error → fail with clear message
- Partial failure → report at end, continue with others

8. **Pending retry**:
- On start, check pending queue
- First sync after init: prompt "Found N unsynced items. Sync all now?"
- Retry pending items before new items

Include complete command structure following jira-init.md pattern (600+ lines).
  </action>
  <verify>
Run syntax check on completed jira-sync.md:
- All acli commands use --json flag
- Hierarchy order enforced (milestone → phase → plan)
- Error handling for all failure modes
- Progress output and completion table documented
- Pending retry logic included
  </verify>
  <done>
Complete gsd:jira-sync command with:
- Sync state management
- Artifact discovery with hash-based change detection
- Jira issue creation with --parent hierarchy
- Conflict detection and --overwrite option
- Progress output and completion summary table
- Error handling with pending queue
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `commands/gsd/jira-sync.md` exists with 400+ lines
2. File follows jira-init.md structure (frontmatter, role, execution flow)
3. Sync state YAML schema fully defined
4. All acli commands documented with examples
5. Hierarchy linking using --parent flag
6. Conflict detection before updates
7. Error handling with pending queue
</verification>

<success_criteria>
- [ ] jira-sync.md created with complete sync logic
- [ ] Sync-state.yaml schema defined and documented
- [ ] Milestone → Initiative (or Epic) creation
- [ ] Phase → Epic creation with parent linking
- [ ] Plan → Story creation with parent linking
- [ ] Conflict detection using Jira updated timestamp
- [ ] Progress output and completion table format
- [ ] Pending queue for failed syncs
</success_criteria>

<output>
After completion, create `.planning/phases/02-push-sync/02-01-SUMMARY.md`
</output>
